{% extends "base.html" %}
{% block content %}
        <h1 class="mb-4">Lista de Dispositivos</h1>

        <a class="btn btn-primary mb-3" href="{% url 'dashboard' %}">Volver al inicio</a>
        
        {% if perms.dispositivos.add_dispositivo %}
        <a class="btn btn-success mb-3" href="{% url 'crear_dispositivo' %}">Agregar Dispositivo</a>
        {% endif %}

        <table class="table table-striped" id="tabla-dispositivos">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Zona</th>
                    <th>Consumo (W)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for dispositivo in dispositivos %}
                <tr id="fila-dispositivo-{{ dispositivo.id }}">
                    <td>{{ dispositivo.nombre }}</td>
                    <td>{{ dispositivo.categoria }}</td>
                    <td>
                        {% if dispositivo.zona %}
                            {{ dispositivo.zona.nombre }}
                        {% else %}
                            Sin zona
                        {% endif %}
                    </td>
                    <td>{{ dispositivo.watts }}</td>
                    <td>
                        {% if perms.dispositivos.view_dispositivo %}
                        <a class="btn btn-sm btn-info" href="{% url 'detalle_dispositivo' dispositivo.id %}">Ver</a>
                        {% endif %}
                        
                        {% if perms.dispositivos.change_dispositivo %}
                        <a class="btn btn-sm btn-warning" href="{% url 'editar_dispositivo' dispositivo.id %}">Editar</a>
                        {% endif %}
                        
                        {% if perms.dispositivos.delete_dispositivo %}
                        <button class="btn btn-sm btn-danger btn-eliminar" 
                                data-url="{% url 'eliminar_dispositivo' dispositivo.id %}"
                                data-nombre="{{ dispositivo.nombre }}"
                                data-fila-id="fila-dispositivo-{{ dispositivo.id }}">
                            Eliminar
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No hay dispositivos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // Función para obtener el token CSRF (Necesario para POST en Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function() {
        const botonesEliminar = document.querySelectorAll('.btn-eliminar');
        
        botonesEliminar.forEach(boton => {
            boton.addEventListener('click', function(e) {
                e.preventDefault(); 
                
                const url = this.dataset.url;
                const nombre = this.dataset.nombre;
                const filaId = this.dataset.filaId;

                // Mostrar alerta de confirmación
                Swal.fire({
                    title: `¿Estás seguro de eliminar "${nombre}"?`,
                    text: "¡Esta acción no se puede deshacer!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, ¡eliminar!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    // Si el usuario confirma
                    if (result.isConfirmed) {
                        // Enviar la petición AJAX
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                // Éxito: Mostrar alerta y eliminar la fila
                                Swal.fire(
                                    '¡Eliminado!',
                                    data.message,
                                    'success'
                                );
                                document.getElementById(filaId).remove();
                            } else {
                                // Error: Mostrar alerta
                                Swal.fire(
                                    'Error',
                                    data.message || 'No se pudo eliminar.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            Swal.fire('Error', 'Error de red.', 'error');
                        });
                    }
                });
            });
        });
    });
    </script>
{% endblock %}
