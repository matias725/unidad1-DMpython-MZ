{% extends "base.html" %}
{% block content %}
        <h1 class="mb-4">Lista de Dispositivos</h1>

        <a class="btn btn-primary mb-3" href="{% url 'dashboard' %}">Volver al inicio</a>
        
        {% if perms.dispositivos.add_dispositivo %}
        <a class="btn btn-success mb-3" href="{% url 'crear_dispositivo' %}">Agregar Dispositivo</a>
        {% endif %}

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="GET" action="{% url 'listar_dispositivos' %}" class="row g-3 align-items-center">
                    
                    <div class="col-md-7">
                        <label for="q" class="visually-hidden">Buscar</label>
                        <input type="text" name="q" id="q" class="form-control" 
                               placeholder="Buscar por nombre, categoría o zona..." value="{{ q }}">
                    </div>

                    <div class="col-md-3">
                        <label for="size" class="visually-hidden">Resultados</label>
                        <select name="size" id="size" class="form-select" onchange="this.form.submit();">
                            <option value="5" {% if size == '5' %}selected{% endif %}>Mostrar 5</option>
                            <option value="10" {% if size == '10' %}selected{% endif %}>Mostrar 10</option>
                            <option value="25" {% if size == '25' %}selected{% endif %}>Mostrar 25</option>
                            <option value="50" {% if size == '50' %}selected{% endif %}>Mostrar 50</option>
                        </select>
                    </div>

                    <div class="col-md-2 d-flex">
                        <button type="submit" class="btn btn-primary flex-grow-1">Buscar</button>
                        {% if q or size != '10' or categoria %}
                        <a href="{% url 'listar_dispositivos' %}" class="btn btn-outline-secondary ms-2" title="Limpiar filtros">Limpiar</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        <table class="table table-striped" id="tabla-dispositivos">
            <thead class="table-dark">
                <tr>
                    <th><a href="?sort=nombre&{{ querystring }}" class="text-white text-decoration-none">Nombre</a></th>
                    <th><a href="?sort=categoria&{{ querystring }}" class="text-white text-decoration-none">Categoría</a></th>
                    <th><a href="?sort=zona&{{ querystring }}" class="text-white text-decoration-none">Zona</a></th>
                    <th><a href="?sort=watts&{{ querystring }}" class="text-white text-decoration-none">Consumo (W)</a></th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for dispositivo in page_obj %}
                <tr id="fila-dispositivo-{{ dispositivo.id }}">
                    <td>{{ dispositivo.nombre }}</td>
                    <td>{{ dispositivo.categoria }}</td>
                    <td>
                        {% if dispositivo.zona %}
                            {{ dispositivo.zona.nombre }}
                        {% else %}
                            Sin zona
                        {% endif %}
                    </td>
                    <td>{{ dispositivo.watts }}</td>
                    <td>
                        {% if perms.dispositivos.view_dispositivo %}
                        <a class="btn btn-sm btn-info" href="{% url 'detalle_dispositivo' dispositivo.id %}">Ver</a>
                        {% endif %}
                        
                        {% if perms.dispositivos.change_dispositivo %}
                        <a class="btn btn-sm btn-warning" href="{% url 'editar_dispositivo' dispositivo.id %}">Editar</a>
                        {% endif %}
                        
                        {% if perms.dispositivos.delete_dispositivo %}
                        <button class="btn btn-sm btn-danger btn-eliminar" 
                                data-url="{% url 'eliminar_dispositivo' dispositivo.id %}"
                                data-nombre="{{ dispositivo.nombre }}"
                                data-fila-id="fila-dispositivo-{{ dispositivo.id }}">
                            Eliminar
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No hay dispositivos registrados (o que coincidan con la búsqueda).</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.has_other_pages %}
    <nav aria-label="Navegación de páginas">
        <ul class="pagination justify-content-center">
            
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&{{ querystring }}">Primera</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ querystring }}">Anterior</a></li>
            {% else %}
                <li class="page-item disabled"><a class="page-link" href="#" tabindex="-1">Primera</a></li>
                <li class="page-item disabled"><a class="page-link" href="#" tabindex="-1">Anterior</a></li>
            {% endif %}
            
            {% for i in page_obj.paginator.get_elided_page_range %}
                {% if page_obj.number == i %}
                    <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                {% elif i == page_obj.paginator.ELLIPSIS %}
                    <li class="page-item disabled"><span class="page-link">{{ i }}</span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}&{{ querystring }}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ querystring }}">Siguiente</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ querystring }}">Última</a></li>
            {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">Siguiente</a></li>
                <li class="page-item disabled"><a class="page-link" href="#">Última</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // Función para obtener el token CSRF (Necesario para POST en Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function() {
        const botonesEliminar = document.querySelectorAll('.btn-eliminar');
        
        botonesEliminar.forEach(boton => {
            boton.addEventListener('click', function(e) {
                e.preventDefault(); 
                
                const url = this.dataset.url;
                const nombre = this.dataset.nombre;
                const filaId = this.dataset.filaId;

                // Mostrar alerta de confirmación
                Swal.fire({
                    title: `¿Estás seguro de eliminar "${nombre}"?`,
                    text: "¡Esta acción no se puede deshacer!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, ¡eliminar!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    // Si el usuario confirma
                    if (result.isConfirmed) {
                        // Enviar la petición AJAX
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                // Éxito: Mostrar alerta y eliminar la fila
                                Swal.fire(
                                    '¡Eliminado!',
                                    data.message,
                                    'success'
                                );
                                document.getElementById(filaId).remove();
                            } else {
                                // Error: Mostrar alerta
                                Swal.fire(
                                    'Error',
                                    data.message || 'No se pudo eliminar.',
                                    'error'
                                );

                            }
                        })
                        .catch(error => {
                            Swal.fire('Error', 'Error de red.', 'error');
                        });
                    }
                });
            });
        });
    });
    </script>
{% endblock %}