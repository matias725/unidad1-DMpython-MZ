{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h1 class="mb-0">Detalle: {{ dispositivo.nombre }}</h1>
        </div>
        <div class="card-body">
            <p><strong>Categoría:</strong> {{ dispositivo.categoria }}</p>
            <p><strong>Zona:</strong>
                {% if dispositivo.zona %}
                    {{ dispositivo.zona.nombre }}
                {% else %}
                    Sin zona
                {% endif %}
            </p>
            <p><strong>Consumo Nominal (W):</strong> {{ dispositivo.watts }}</p>
        </div>
    </div>

    <h3 class="mt-4">Mediciones</h3>
    <div class="card shadow-sm">
        <ul class="list-group list-group-flush">
            {% for medicion in mediciones %}
                <li class="list-group-item">
                    {{ medicion.fecha|date:"d/m/Y H:i" }} - {{ medicion.consumo }} kWh
                </li>
            {% empty %}
                <li class="list-group-item">No hay mediciones registradas.</li>
            {% endfor %}
        </ul>
    </div>

    <h3 class="mt-4">Alertas Graves</h3>
    <div class="card">
        <ul class="list-group list-group-flush">
            {% for medicion in alertas_grave %}
                <li class="list-group-item list-group-item-danger">
                    {{ medicion.fecha|date:"d/m/Y H:i" }} - {{ medicion.consumo }} kWh
                </li>
            {% empty %}
                <li class="list-group-item">No hay alertas graves.</li>
            {% endfor %}
        </ul>
    </div>

    <h3 class="mt-4">Alertas Altas</h3>
    <div class="card">
        <ul class="list-group list-group-flush">
            {% for medicion in alertas_alta %}
                <li class="list-group-item list-group-item-warning">
                    {{ medicion.fecha|date:"d/m/Y H:i" }} - {{ medicion.consumo }} kWh
                </li>
            {% empty %}
                <li class="list-group-item">No hay alertas altas.</li>
            {% endfor %}
        </ul>
    </div>

    <h3 class="mt-4">Alertas Medias</h3>
    <div class="card">
        <ul class="list-group list-group-flush">
            {% for medicion in alertas_media %}
                <li class="list-group-item list-group-item-info">
                    {{ medicion.fecha|date:"d/m/Y H:i" }} - {{ medicion.consumo }} kWh
                </li>
            {% empty %}
                <li class="list-group-item">No hay alertas medias.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="mt-4">
        <a href="{% url 'listar_dispositivos' %}" class="btn btn-secondary">Volver a Dispositivos</a>
        <a href="{% url 'editar_dispositivo' dispositivo.id %}" class="btn btn-warning">Editar</a>
        
        <button class="btn btn-danger btn-eliminar-detalle" 
                data-url="{% url 'eliminar_dispositivo' dispositivo.id %}"
                data-nombre="{{ dispositivo.nombre }}"
                data-redirect-url="{% url 'listar_dispositivos' %}">
            Eliminar
        </button>
    </div>
</div>

<script>
    // Función para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    document.addEventListener('DOMContentLoaded', function() {
        const botonEliminar = document.querySelector('.btn-eliminar-detalle');
        
        if (botonEliminar) {
            botonEliminar.addEventListener('click', function(e) {
                e.preventDefault(); 
                
                const url = this.dataset.url;
                const nombre = this.dataset.nombre;
                const redirectUrl = this.dataset.redirectUrl;

                Swal.fire({
                    title: `¿Estás seguro de eliminar "${nombre}"?`,
                    text: "¡Esta acción no se puede deshacer!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, ¡eliminar!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.ok) {
                                // Éxito: Mostrar alerta y REDIRIGIR
                                Swal.fire(
                                    '¡Eliminado!',
                                    data.message,
                                    'success'
                                ).then(() => {
                                    // Redirigir al listado
                                    window.location.href = redirectUrl; 
                                });
                            } else {
                                Swal.fire('Error', data.message || 'No se pudo eliminar.', 'error');
                            }
                        })
                        .catch(error => {
                            Swal.fire('Error', 'Error de red.', 'error');
                        });
                    }
                });
            });
        }
    });
</script>
{% endblock %}